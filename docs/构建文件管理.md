# 📦 构建文件管理

## 概述

本项目采用自动构建和部署策略，构建文件（`dist` 目录）不包含在 Git 仓库中，而是通过 GitHub Actions 自动生成和部署。项目已实现多项性能优化，包括文章内容分离、语言文件分离等。

## 构建文件策略

### ❌ 不包含在 Git 仓库中的文件

- `dist/` - 构建输出目录
- `node_modules/` - 依赖包目录
- `.env*` - 环境变量文件
- `*.log` - 日志文件
- `src/data/.articles-cache.json` - 文章生成缓存文件

### ✅ 包含在 Git 仓库中的文件

- 源代码文件（`src/`）
- 配置文件（`package.json`, `vite.config.ts` 等）
- 文档文件（`docs/`）
- 文章内容（`articles/`）
- 静态资源（`public/`）

## 性能优化策略

### 🚀 文章内容分离优化

#### 问题背景
- 原方案：所有文章内容打包到 `articles.json` 中，包含在 JS bundle 里
- 问题：随着文章增多，JS 文件会越来越大，影响页面加载性能

#### 优化方案
✅ **文章元数据与内容分离**：
- 元数据：标题、摘要、标签、文件路径等（轻量级）
- 内容：通过 HTTP 请求动态加载 Markdown 文件

✅ **构建时文件复制**：
- `articles/` 文件夹 → `dist/articles/`
- `src/data/articles.json` → `dist/data/articles.json`

✅ **动态加载机制**：
- 页面加载时只获取文章列表（轻量级）
- 用户点击文章时，通过 `fetch('/articles/xxx.md')` 获取内容
- 支持 Markdown front matter 解析

#### 性能提升对比
- **优化前**：`articles.json` 31KB（包含所有文章内容）
- **优化后**：`articles.json` 6.8KB（仅包含元数据）
- **JS Bundle**：大小保持不变，不会因文章增多而变大

### 🌍 语言文件分离优化

#### 问题背景
- 原方案：语言文件打包到 JS bundle 中
- 问题：增加初始加载时间，不支持按需加载

#### 优化方案
✅ **语言文件动态加载**：
- 语言文件从 JS bundle 中分离
- 通过 `fetch('/locales/zh-CN.json')` 动态加载
- 支持缓存机制，避免重复请求

✅ **构建时文件复制**：
- `src/locales/` → `dist/locales/`
- 支持开发和生产环境

✅ **语言服务优化**：
- 保持原有的 `languageService.getText()` 调用方式
- 内部实现动态加载和缓存
- 支持同步和异步两种调用方式

#### 性能提升对比
- **优化前**：JS Bundle 包含所有语言文件（约 10KB）
- **优化后**：JS Bundle 减少约 10KB，语言文件按需加载

## 构建流程

### 本地开发

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建项目（包含智能文章生成）
npm run build

# 预览构建结果
npm run preview
```

### 自动部署

1. **推送代码**：将代码推送到 `main` 分支
2. **自动构建**：GitHub Actions 自动运行构建流程（包含智能文章生成）
3. **自动部署**：构建完成后自动部署到 GitHub Pages

## 构建文件说明

### dist/ 目录结构

```
dist/
├── index.html              # 主页面
├── 404.html               # 404 页面（SPA 路由处理）
├── assets/                # 静态资源
│   ├── css/              # 样式文件
│   ├── js/               # JavaScript 文件（优化后更小）
│   └── images/           # 图片文件
├── articles/              # 文章 Markdown 文件（动态加载）
│   ├── 项界新探/
│   ├── 项目管理/
│   └── 高项学习/
├── data/
│   └── articles.json     # 文章元数据（轻量级）
├── locales/              # 语言文件（动态加载）
│   ├── zh-CN.json       # 中文语言包
│   └── en-US.json       # 英文语言包
├── favicon.ico           # 网站图标
├── logo.jpg              # Logo 图片
└── CNAME                 # 自定义域名配置
```

### 构建优化

- **代码分割**：vendor 和 router 代码分别打包
- **资源压缩**：CSS 和 JS 文件自动压缩
- **缓存优化**：文件名包含哈希值，便于缓存更新
- **模块化**：使用 ES 模块格式
- **内容分离**：文章内容和语言文件从 JS bundle 中分离
- **按需加载**：支持动态加载文章内容和语言文件

## 部署配置

### GitHub Pages 设置

- **Source**：Deploy from a branch
- **Branch**：`gh-pages`
- **Folder**：`/ (root)`

## 优势

### 1. 仓库大小优化

- 不包含构建文件，保持仓库轻量
- 减少 Git 历史记录大小
- 提高克隆和拉取速度

### 2. 自动化部署

- 每次推送代码自动构建和部署
- 确保部署的代码与源代码一致
- 减少手动操作错误

### 3. 环境一致性

- 构建环境统一（GitHub Actions）
- 避免本地环境差异导致的问题
- 确保生产环境稳定性

### 4. 性能优化

- **更小的 JS Bundle**：文章内容和语言文件分离
- **按需加载**：只加载当前使用的资源
- **缓存友好**：静态资源可以单独缓存
- **可扩展性**：添加内容不会影响 JS 文件大小

## 文章生成优化

### 智能检测机制

文章生成脚本 (`scripts/generateArticles.js`) 已优化为智能检测模式：

#### 检测功能
- ✅ **文件变化检测** - 通过 MD5 哈希值和修改时间检测文件变化
- ✅ **新文件检测** - 自动识别新增的文章文件
- ✅ **删除文件检测** - 检测已删除的文件
- ✅ **修改文件检测** - 检测文件内容的修改

#### 缓存机制
- **缓存文件**: `src/data/.articles-cache.json`
- **缓存内容**: 文件哈希值、修改时间、文章数量
- **缓存更新**: 仅在文件变化时更新缓存

### 工作流程

1. **检查缓存** - 读取 `.articles-cache.json` 缓存文件
2. **扫描文件** - 扫描 `articles/` 目录下的所有 Markdown 文件
3. **对比变化** - 比较当前文件与缓存中的记录
4. **智能决策**:
   - 无变化 → 跳过生成，显示 "文章文件无变化，跳过生成"
   - 有变化 → 重新生成文章数据并更新缓存

### 性能提升

#### 构建时间对比
- **优化前**: 每次构建都重新扫描和生成文章数据
- **优化后**: 仅在文件变化时重新生成，大幅减少构建时间

#### 检测精度
- **文件哈希**: MD5 哈希确保内容变化的准确检测
- **修改时间**: 文件修改时间作为辅助检测
- **双重验证**: 哈希值 + 修改时间双重验证

## 缓存文件说明

### 缓存文件结构
```json
{
  "files": {
    "README.md": {
      "hash": "9b2344c5a57997acff04287ff42c89bf",
      "mtime": 1754202701092
    },
    "高项学习/了解高项考试.md": {
      "hash": "987f5622e99223482ea26dbf95c4a2b3",
      "mtime": 1754212457657
    }
  },
  "lastUpdated": "2025-08-03T09:46:49.473Z",
  "articleCount": 1
}
```

### 缓存文件管理
- **自动生成**: 首次运行脚本时自动生成
- **自动更新**: 文件变化时自动更新
- **Git 忽略**: 已添加到 `.gitignore`，不会被提交到仓库

## 动态加载机制

### 文章内容加载

```typescript
// 文章服务中的动态加载
async getArticleBySlug(slug: string): Promise<Article | null> {
  const articleMeta = this.articlesMeta.find(a => a.slug === slug);
  if (!articleMeta) return null;

  try {
    // 动态加载文章内容
    const response = await fetch(`/articles/${articleMeta.filePath}`);
    const content = await response.text();
    
    // 解析 Markdown front matter
    const { data, content: markdownContent } = this.parseFrontMatter(content);
    
    return {
      ...articleMeta,
      content: markdownContent,
    };
  } catch (error) {
    console.error('加载文章内容失败:', error);
    return null;
  }
}
```

### 语言文件加载

```typescript
// 语言服务中的动态加载
private async loadLocaleData(language: Language): Promise<LocaleData> {
  if (localeCache[language]) {
    return localeCache[language];
  }

  try {
    const response = await fetch(`/locales/${language}.json`);
    const localeData = await response.json();
    localeCache[language] = localeData;
    return localeData;
  } catch (error) {
    console.error(`Failed to load locale data for ${language}:`, error);
    return {};
  }
}
```

## 故障排除

### 常见问题

#### 1. 缓存文件损坏
**症状**: 脚本报错或无法正确检测变化
**解决**: 删除 `.articles-cache.json` 文件，重新运行脚本

#### 2. 文件变化未检测到
**症状**: 修改文件后脚本仍显示"无变化"
**解决**: 
```bash
rm src/data/.articles-cache.json
npm run generate-articles
```

#### 3. 构建时间过长
**症状**: 构建时间没有明显改善
**解决**: 检查是否有大量文件变化，或清除缓存重新生成

#### 4. 动态加载失败
**症状**: 文章内容或语言文件无法加载
**解决**: 
- 检查网络连接
- 确认文件路径正确
- 查看浏览器控制台错误信息

### 调试命令

```bash
# 查看缓存文件
cat src/data/.articles-cache.json

# 删除缓存强制重新生成
rm src/data/.articles-cache.json && npm run generate-articles

# 检查文件变化
ls -la articles/

# 检查构建结果
ls -la dist/
```

## 最佳实践

### 开发建议
1. **定期清理**: 如果遇到问题，删除缓存文件重新生成
2. **文件命名**: 使用有意义的文件名，便于管理
3. **目录结构**: 按主题组织文章目录结构
4. **内容分离**: 将大量内容从 JS bundle 中分离出来

### 性能优化
1. **批量修改**: 一次性修改多个文件，减少检测次数
2. **避免频繁修改**: 减少不必要的文件修改
3. **定期维护**: 定期清理无用的文章文件
4. **缓存策略**: 合理利用浏览器缓存机制

### 部署优化
1. **CDN 配置**: 配置 CDN 加速静态资源加载
2. **缓存策略**: 设置合适的缓存头
3. **压缩优化**: 启用 Gzip 压缩
4. **监控分析**: 使用性能监控工具分析加载性能

## 技术实现

### 核心算法
- **MD5 哈希**: 使用 Node.js 内置的 crypto 模块
- **文件扫描**: 递归扫描目录结构
- **变化检测**: 哈希值 + 修改时间双重验证
- **动态加载**: 使用 fetch API 实现按需加载

### 依赖模块
- `fs` - 文件系统操作
- `path` - 路径处理
- `crypto` - 哈希计算
- `gray-matter` - Markdown 解析
- `fetch` - 动态资源加载

### Vite 插件
- **copyArticlesPlugin**: 复制文章文件夹到 dist
- **pwaPlugin**: 处理 PWA 相关请求
- **开发服务器中间件**: 处理动态文件请求

---

💡 **提示**：如果您需要本地测试构建结果，可以使用 `npm run preview` 命令在本地预览构建后的网站。性能优化后的网站加载速度更快，支持更多内容而不会影响性能。 