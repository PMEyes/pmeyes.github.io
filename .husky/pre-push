# 获取当前分支名
current_branch=$(git symbolic-ref --short HEAD)

# 检查是否在 main 分支上
if [ "$current_branch" = "main" ]; then
    # 检查最近的提交信息，避免递归触发
    last_commit_msg=$(git log -1 --pretty=%B)
    if [[ "$last_commit_msg" == *"[skip ci]"* ]] || [[ "$last_commit_msg" == *"自动提交部署生成的文件"* ]]; then
        echo "ℹ️  检测到自动提交，跳过部署以避免递归"
        exit 0
    fi
    
    echo "🚀 检测到 main 分支 push，开始自动部署..."
    
    # 执行部署脚本
    npm run deploy
    
    if [ $? -eq 0 ]; then
        echo "✅ 部署成功！"
        
        # 检查是否有新文件需要提交
        if [ -n "$(git status --porcelain)" ]; then
            echo "📝 发现新文件，正在提交..."
            git add .
            git commit -m "chore: 自动提交部署生成的文件 [skip ci]"
            echo "✅ 文件已提交"
        fi
    else
        echo "❌ 部署失败，请检查错误信息"
        exit 1
    fi
else
    echo "ℹ️  当前分支: $current_branch，跳过自动部署"
fi 